## ================================================
# Below is your production-ready, VPS bootstrap playbook, 
# engineered for a single-VM microservices staging environment.
# It prepares an Ubuntu host with:
# It prepares an Ubuntu host with:
# -- Docker Engine (latest stable)
# -- Docker Compose v2
# -- Local Docker registry registry.local:5000
# -- System swap (2GB or configurable)
# -- Kernel/sysctl tuning for containers
# -- Firewall (UFW) rules
# -- Optional monitoring agents (Node Exporter)
# -- Proper directory structure under /opt/socialx
# -- User permissions configuration
# -- It is fully idempotent and safe to rerun.

# Execution command in your local machine terminal ,
# ansible-playbook -i <vps_ip>, -u ubuntu --private-key ~/.ssh/id_rsa ansible/provision-vps.yml
## ================================================



## ================================================
# Provision a fresh Ubuntu VPS for SocialX microservices platform
# Supports: Docker, Docker Compose v2, Local Registry, Swap, Firewall, System tuning
# This playbook is designed for staging / single-server initial deployments.

- hosts: all
  become: true
  vars:
    app_name: "socialx"
    registry_port: 5000
    swap_size_mb: 2048
    docker_user: ubuntu

  tasks:

  ###########################################################################
  # UPDATE SYSTEM
  ###########################################################################
  - name: Update apt cache
    apt:
      update_cache: yes
      cache_valid_time: 3600

  - name: Upgrade system packages
    apt:
      upgrade: dist
      autoremove: yes

  ###########################################################################
  # INSTALL DOCKER ENGINE + DOCKER COMPOSE V2
  ###########################################################################
  - name: Install prerequisite packages for Docker
    apt:
      name:
        - apt-transport-https
        - ca-certificates
        - curl
        - software-properties-common
        - gnupg-agent
      state: present

  - name: Add Docker GPG key
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present

  - name: Add Docker APT repository
    apt_repository:
      repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
      state: present

  - name: Install Docker engine
    apt:
      name:
        - docker-ce
        - docker-ce-cli
        - containerd.io
      state: present

  - name: Install Docker Compose v2
    get_url:
      url: https://github.com/docker/compose/releases/download/v2.28.1/docker-compose-linux-x86_64
      dest: /usr/local/bin/docker-compose
      mode: '0755'

  - name: Add user to docker group
    user:
      name: "{{ docker_user }}"
      groups: docker
      append: yes

  ###########################################################################
  # LOCAL DOCKER REGISTRY (registry.local:5000)
  ###########################################################################
  - name: Create registry data directory
    file:
      path: /opt/{{ app_name }}/registry
      state: directory
      owner: root
      group: root
      mode: 0755

  - name: Start local Docker registry
    docker_container:
      name: local-registry
      image: registry:2
      restart_policy: always
      published_ports:
        - "{{ registry_port }}:5000"
      volumes:
        - /opt/{{ app_name }}/registry:/var/lib/registry

  ###########################################################################
  # CREATE APPLICATION FOLDER STRUCTURE
  ###########################################################################
  - name: Create base directory structure
    file:
      path: "/opt/{{ app_name }}/{{ item }}"
      state: directory
      owner: "{{ docker_user }}"
      group: "{{ docker_user }}"
      mode: 0755
    loop:
      - configs
      - logs
      - data
      - services
      - docker

  ###########################################################################
  # SYSTEM SWAP (2GB default)
  ###########################################################################
  - name: Check if swapfile exists
    stat:
      path: /swapfile
    register: swapfile_check

  - name: Create swapfile
    command: |
      fallocate -l {{ swap_size_mb }}M /swapfile
    when: not swapfile_check.stat.exists

  - name: Set swap permissions
    file:
      path: /swapfile
      mode: 0600
    when: not swapfile_check.stat.exists

  - name: Make swap
    command: mkswap /swapfile
    when: not swapfile_check.stat.exists

  - name: Enable swap
    command: swapon /swapfile
    when: not swapfile_check.stat.exists

  - name: Add swap entry to /etc/fstab
    lineinfile:
      path: /etc/fstab
      line: "/swapfile none swap sw 0 0"
      state: present

  ###########################################################################
  # SYSTEM & NETWORK TUNING
  ###########################################################################
  - name: Apply common sysctl settings
    copy:
      dest: /etc/sysctl.d/99-socialx.conf
      content: |
        net.core.somaxconn = 1024
        net.ipv4.ip_forward = 1
        fs.file-max = 500000
        vm.swappiness = 10
    notify: Reload sysctl

  ###########################################################################
  # FIREWALL CONFIGURATION
  ###########################################################################
  - name: Enable UFW
    ufw:
      state: enabled
      policy: allow

  - name: Allow SSH
    ufw:
      rule: allow
      name: OpenSSH

  - name: Allow HTTP/HTTPS
    ufw:
      rule: allow
      port: "80,443"
      proto: tcp

  - name: Allow local registry
    ufw:
      rule: allow
      port: "{{ registry_port }}"
      proto: tcp

  ###########################################################################
  # OPTIONAL MONITORING AGENT (Node Exporter)
  ###########################################################################
  - name: Create node exporter service
    docker_container:
      name: node-exporter
      image: prom/node-exporter
      restart_policy: always
      published_ports:
        - "9100:9100"
      volumes:
        - /proc:/host/proc:ro
        - /sys:/host/sys:ro
        - /:/rootfs:ro

  ###########################################################################
  # FINISHED
  ###########################################################################
  - name: Display completion message
    debug:
      msg: |
        VPS Provisioning complete!
        Docker + Compose installed.
        Local Registry running on port {{ registry_port }}.
        Swap, sysctl, UFW, monitoring configured.
        Server ready for SocialX deployment.
  
  handlers:
    - name: Reload sysctl
      command: sysctl --system

